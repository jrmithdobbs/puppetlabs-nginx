<%# This replaces any listen lines from vhost_header template with correct port and ssl option. -%>
<%= scope.function_template(['nginx/vhost/vhost_header.erb'])
    .gsub!(/listen ([^]]*[]]|[^:]*):#{scope.lookupvar('listen_port')} /,
      "listen \\1:#{scope.lookupvar('ssl_port')} ssl ") -%>
  ssl_prefer_server_ciphers on;
  ssl_protocols <%= ssl_protocols.join(' ') %> ;
  ssl_ciphers "<%= ssl_ciphers.join(':') %>" ;
  ssl_certificate     <%= ssl_cert %>;
  ssl_certificate_key <%= ssl_key %>;
<%# Since we allow <= TLSv1.1 we must set timeout to <= 5m -%>
  ssl_session_timeout 5m;
